<!DOCTYPE html>
<html>
    <body>
        <!-- Add a svg area, empty -->
        <div id="area"></div>

        <!-- Load d3.js -->
        <script src="https://d3js.org/d3.v4.js"></script>

       <!-- <button onclick="triggerTransitionAxis()">Trigger transition</button> -->


        <script>

            let radius = 20

            let margin = {top: 10, right: 40, bottom: 30, left: 30},
                width = 1200 - margin.left - margin.right,
                height = 800 - margin.top - margin.bottom;
            
            let actions = ['Left', 'Jump', 'Right']


            let keys = "RJjrRrJRjrJRrRjrJLljLJljLlRJjJjJjJjJjJLjrJljRJjrLlRJjJjr"

            
            let sVg = d3.select('#area')
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

            // X scale and Axis
            let x = d3.scaleLinear()
                .domain([0,keys.length])         // This is the min and the max of the data: 0 to 100 if percentages
                .range([0, width]);       // This is the corresponding value I want in Pixel
            
            let xAxis = sVg.append("g")
                .attr("transform", "translate(" + 2*radius + "," + height + ")")
                .call(d3.axisBottom(x));


            // Y scale and Axis
            let y = d3.scaleBand()
                .domain(actions)        
                .range([0, height])
                .padding(1);       

            let yAxis = sVg.append('g')
                .attr("transform", "translate(" + 2*radius + ",0)")
                .call(d3.axisLeft(y));

            let rectPos = createRectFromText(keys);


            sVg.append("circle")
                 .attr("cx", x(0)).attr("cy", y("Left")).attr("r", radius/2).style("fill", "blue");
            sVg.append("circle")
                 .attr("cx", x(0)).attr("cy", y("Jump")).attr("r", radius/2).style("fill", "red");
            sVg.append("circle")
                 .attr("cx", x(0)).attr("cy", y("Right")).attr("r", radius/2).style("fill", "green");


            
            // Add a clipPath: everything out of this area won't be drawn.
            var clip = sVg.append("defs").append("sVg:clipPath")
                .attr("id", "clip")
                .append("sVg:rect")
                .attr("width", width )
                .attr("height", height )
                .attr("x", 0)
                .attr("y", 0);

            var rects = sVg.append('g')
                .attr("clip-path", "url(#clip)")


            rects.selectAll("rect")
                .data(rectPos)
                .enter()
                .append("rect")
                    .attr("width", function(d){return x(d.width)})
                    .attr("x", function(d){return x(d.x)})
                    .attr("y", function(d){return y(d.y)})
                    .attr("height", function(d){return d.height})
                    .attr("transform", "translate(" + 2*radius + ", 0)")
                    .attr("fill", "#8B0000")


            var zoom = d3.zoom()
                .extent([[0, 0], [width, height]])
                .on("zoom", triggerTransitionAxis);

            sVg.append("rect")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
                .call(zoom);

            
            function triggerTransitionAxis(){

            //  x.domain([15,keys.length])

            //     sVg.selectAll("rect")
            //    .transition()
            //    .duration(5000)
            //    .attr("x", 0)
            //    .transition()
            //    .attr("width", 0)

            //     // Update the axis
            //     sVg.select(".x_axis")
            //     .transition()
            //     .duration(5000)
            //     .call(d3.axisBottom(x)) 

                let newX = d3.event.transform.rescaleX(x);

                // update axes with these new boundaries
                xAxis.call(d3.axisBottom(newX))

                // update circle position
                rects
                    .selectAll("rect")
                    // .attr("width", function(d){return newX(d.width)})
                    .attr("x", function(d){return newX(d.x)})
            }


            function createRectFromText(text){

                let positions = []

                for(let i = 0, end ; i <= text.length ; i++){
                    switch(text[i]){
                        case 'R':
                            end = text.slice(i).indexOf("r") + i;
                            positions.push({x:i, 
                                          y:'Right',
                                          width: end-i,
                                          height:30})
                            console.log(x(i), x(end-i))
                            break;
                        case 'J':
                            end = text.slice(i).indexOf("j") + i;
                            positions.push({x:i, 
                                          y:'Jump',
                                          width: end-i,
                                          height:30})
                            break;
                        case 'L': 
                            end = text.slice(i).indexOf("l") + i;
                            positions.push({x:i, 
                                          y:'Left',
                                          width: end-i,
                                          height:30})
                            break;
                        default:
                            break;
                    }
                }

                return positions
            }

            
        </script>

    </body>
</html>
