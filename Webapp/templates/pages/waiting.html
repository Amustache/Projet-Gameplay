{% extends 'layouts/main.html' %}
{% block title %}{{ _('Loading') }}{% endblock %}
{% block content %}

    <h1 class="mt-5">{{ _('Loading in progress') }}</h1>
    <p class="mt-5"><img src="static/img/cat.gif" width="5%"></p>
    <div class="progress">
        <div id="progress-bar" class="progress-bar progress-bar-striped bg-danger progress-bar-animated"
             role="progressbar" aria-label="Processing the video" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
             aria-valuemax="100"><span id="progress">0%</span></div>
    </div>

{% endblock %}

{% block javascript %}
    <script>
        setInterval(() => {
            const request = new XMLHttpRequest()
            request.open("GET", "/progression")
            request.responseType = "json"
            request.send()
            request.onload = () => {
                let result;
                let filename;
                if (request.readyState === 4 && request.status === 200) {
                    if (request.response.progression === 1) {
                        filename = (new URLSearchParams(window.location.search)).get("filename")
                        window.location.replace("{{ url_for('experience_show') }}?filename=" + filename);
                    }
                    result = parseInt(request.response.progression * 1000) / 10
                } else {
                    result = "Impossible de communiquer avec le serveur"
                }
                document.getElementById("progress-bar").setAttribute("aria-valuenow", result)
                document.getElementById("progress-bar").style = result.concat("%")
                document.getElementById("progress").innerHTML = result.concat("%")

            };
        }, 3000)
    </script>
{% endblock %}
